---
machine:
  python:
    version: 3.6.0
  post:
    - pyenv global 3.6.0 3.5.1 3.4.4 2.7.12
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx1024m"
dependencies:
  override:
    - pip install -r requirements.txt --extra-index-url=https://$PYPI_USER:$PYPI_PASSWORD@mindmeld.com/pypi -U
  post:
    - wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.2.tar.gz
    - tar -xvf elasticsearch-5.1.2.tar.gz
    - elasticsearch-5.1.2/bin/elasticsearch: {background: true}
    # Make sure that Elasticsearch is up before running tests:
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/
    # Setup food ordering kb
    - mmworkbench blueprint food_ordering
test:
  pre:
    - pip install -r test-requirements.txt
    - mmworkbench num-parse:
        background: true
    # Make sure that numerical parser is running
    - while ! nc -z localhost 2626; do sleep 5; done;:
        timeout: 150
    - python -c "from mmworkbench.ser import parse_numerics; parse_numerics('100 degrees')"
  override:
    - ./lintme
    - cd blueprints/home_assistant && python app.py build && ./testme
    - cd blueprints/video_discovery && python app.py build
    - cd blueprints/food_ordering && python app.py build

deployment:
  s3:
    branch: /(develop)|(staging)|(master)/
    commands:
      - MM_BRANCH=$CIRCLE_BRANCH bash scripts/upload_blueprints.sh
